# Maven
# Build your Java project and run tests with Apache Maven.
# Add steps that analyze code, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/java

trigger:
  branches:
    include:
      - main
      - dev

pool:
  name: 'MySelfHostedpool'
  demands: []

steps:

  # prepare sonar cloud
  - task: SonarCloudPrepare@3
    inputs:
      SonarCloud: 'SonarCloudServiceConnection'
      organization: 'devanshi-rangras'
      scannerMode: 'CLI'
      configMode: 'manual'
      cliProjectKey: 'Devanshi-Rangras_sample-job-portal'
      cliProjectName: 'JobPortal'
      cliSources: '.'
  
  #setup jdk for spring boot backend
  - powershell: |
      Invoke-WebRequest -Uri "https://github.com/adoptium/temurin21-binaries/releases/download/jdk-21.0.2%2B13/OpenJDK21U-jdk_x64_windows_hotspot_21.0.2_13.zip" -OutFile "C:\agent\_work\jdk.zip"
      Expand-Archive "C:\agent\_work\jdk.zip" -DestinationPath "C:\agent\_work\jdk"
      echo "##vso[task.setvariable variable=JAVA_HOME]C:\agent\_work\jdk\jdk-21.0.2+13"
      echo "##vso[task.prependpath]C:\agent\_work\jdk\jdk-21.0.2+13\bin"
      java -version
    displayName: "Download & Setup JDK 21"
  
  #Build & test backend with Maven
  - script: |
      cd backend
      mvn clean verify
    displayName: 'Build & Test Backend (Maven)'

  #Setup Node.js for frontend 
  - task: NodeTool@0 
    inputs: 
      versionSpec: '18.x' 
    displayName: 'Install Node.js'

  #Build & test frontend 
  - script: | 
      cd frontend 
      npm install 
      npm run build 
      npm test -- --coverage || echo "No tests found" 
    displayName: 'Build & Test Frontend'

  #Run SonarCloud Analysis 
  - task: SonarCloudAnalyze@3

  #Publish results (Quality Gate) 
  - task: SonarCloudPublish@3
    inputs: 
      pollingTimeoutSec: '300'